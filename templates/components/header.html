{% from "components/menu-modal.html" import menu_modal %}
{% from "components/theme-switcher.html" import theme_switcher_compact %}

{% macro header() %}
<header class="w-full fixed top-0 z-50 px-4 py-4 bg-background">
  {{ menu_modal() }}

  <div class="container mx-auto flex justify-between items-center h-[4rem] border-b border-border">
    <span id="banner">
      <a href="/" hx-get="/" hx-target="#content" hx-push-url="true">Krondor</a>
    </span>
    <div class="flex items-center gap-4">
      <!-- Theme Switcher -->
      {{ theme_switcher_compact() }}
      
      <input type="checkbox" id="menu-toggle" class="hidden"/>
      <label for="menu-toggle" class="cursor-pointer p-4">
        <div id="menu-icon" class="w-8 h-6 relative">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </div>
      </label>
    </div>
  </div>

  <script>
    // Global menu state management
    window.menuState = window.menuState || {
      escapeHandler: null,
      outsideClickHandler: null
    };
    
    function initializeMenu() {
      const menuDialog = document.getElementById('menu-dialog');
      const menuToggle = document.getElementById('menu-toggle');
      const menuClose = document.getElementById('menu-close');
      
      // Exit if elements don't exist
      if (!menuDialog || !menuToggle || !menuClose) return;
      
      function toggleMenu(open = null) {
        const isOpen = open !== null ? open : !menuDialog.open;
        menuDialog.open = isOpen;
        menuToggle.checked = isOpen;
        
        // Toggle body scroll
        if (isOpen) {
          document.body.classList.add('body-no-scroll');
        } else {
          document.body.classList.remove('body-no-scroll');
        }
      }

      // Remove old event listeners
      if (window.menuState.escapeHandler) {
        document.removeEventListener('keydown', window.menuState.escapeHandler);
      }
      if (window.menuState.outsideClickHandler) {
        menuDialog.removeEventListener('click', window.menuState.outsideClickHandler);
      }

      // Remove old event listeners by cloning and replacing elements
      const newMenuToggle = menuToggle.cloneNode(true);
      menuToggle.parentNode.replaceChild(newMenuToggle, menuToggle);
      
      const newMenuClose = menuClose.cloneNode(true);
      menuClose.parentNode.replaceChild(newMenuClose, menuClose);

      // Close menu when a link is clicked
      menuDialog.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
          toggleMenu(false);
        });
      });

      // Toggle menu when checkbox is clicked
      newMenuToggle.addEventListener('click', () => toggleMenu());

      // Close menu when clicking X button
      newMenuClose.addEventListener('click', () => toggleMenu(false));

      // Close menu when clicking outside
      window.menuState.outsideClickHandler = function(event) {
        if (event.target === menuDialog) {
          toggleMenu(false);
        }
      };
      menuDialog.addEventListener('click', window.menuState.outsideClickHandler);

      // Close menu when escape key is pressed
      window.menuState.escapeHandler = function(event) {
        if (event.key === 'Escape' && menuDialog.open) {
          toggleMenu(false);
        }
      };
      document.addEventListener('keydown', window.menuState.escapeHandler);
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeMenu);
    } else {
      initializeMenu();
    }
    
    // Force close menu before HTMX navigation
    document.addEventListener('htmx:beforeRequest', function(event) {
      const menuDialog = document.getElementById('menu-dialog');
      const menuToggle = document.getElementById('menu-toggle');
      if (menuDialog && menuDialog.open) {
        menuDialog.open = false;
        menuToggle.checked = false;
        document.body.classList.remove('body-no-scroll');
      }
    });
    
    // Re-initialize menu after HTMX swaps
    document.addEventListener('htmx:afterSwap', function(event) {
      // Always re-initialize after content swap
      if (event.detail.target.id === 'content') {
        setTimeout(initializeMenu, 0);
      }
    });
  </script>
</header>
{% endmacro %}